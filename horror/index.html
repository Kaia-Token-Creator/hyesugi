<!DOCTYPE html>
<html lang="ko">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QR5TWB3RYJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QR5TWB3RYJ');
  </script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9891583086388017" crossorigin="anonymous"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>당신을 공포게임에 초대합니다..</title>
  <meta name="description" content="당신을 공포게임에 초대합니다.." />
  <link rel="canonical" href="https://hyesugi.com/horror" />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#000000" />

  <link rel="icon" href="https://hyesugi.com/favicon.ico" sizes="any" />
  <link rel="apple-touch-icon" href="https://hyesugi.com/apple-touch-icon.png" sizes="180x180" />
  <link rel="manifest" href="https://hyesugi.com/site.webmanifest" />

  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="hyesugi.com/horror" />
  <meta property="og:url" content="https://hyesugi.com/horror" />
  <meta property="og:title" content="당신을 공포게임에 초대합니다.." />
  <meta property="og:description" content="당신을 공포게임에 초대합니다.." />
  <meta property="og:image" content="https://hyesugi.com/horror/preview.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="혜숙이의 공포게임 미리보기" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="당신을 공포게임에 초대합니다..기" />
  <meta name="twitter:description" content="당신을 공포게임에 초대합니다.." />
  <meta name="twitter:image" content="https://hyesugi.com/horror/preview.jpg" />

  <link rel="preload" as="image" href="https://hyesugi.com/horror/preview.jpg" imagesrcset="https://hyesugi.com/horror/preview.jpg" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#000000;
      --panel:#0b0b0b;
      --ink:#e60000;
      --ink-dim:#d20000;
      --btn-bg:#111111;
      --btn-bg-hover:#1c1c1c;
      --ring:rgba(230,0,0,0.5);
    }
    html, body { background: var(--bg); }
    body {
      color: var(--ink);
      font-family: "Gungsuh","GungSeo","Batang","Gowun Batang","Nanum Myeongjo",serif;
      letter-spacing: .2px;
    }
    ::selection { background:#700; color:#fff; }

    /* 텍스트 입력 계열 요소를 빨간 궁서체로 */
    input, textarea, select {
      color: var(--ink); /* 빨간색 글씨 */
      font-family: "Gungsuh","GungSeo","Batang","Gowun Batang","Nanum Myeongjo",serif;
      background-color: #000;   /* 검은 배경 */
      border: 1px solid #444;   /* 경계선 어둡게 */
      padding: 0.5rem;
    }
    input::placeholder, textarea::placeholder {
      color: #800; /* 플레이스홀더도 붉은 느낌 */
      font-family: "Gungsuh","GungSeo","Batang","Gowun Batang","Nanum Myeongjo",serif;
    }
  </style>
</head>

<body class="bg-black font-sans">
  <div id="app" class="flex flex-col min-h-screen max-w-3xl mx-auto bg-black">

    <header class="bg-black text-center py-4 shadow-md relative">
      <h1 class="text-xl font-bold text-red-600 flex items-center justify-center gap-2" style="font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
        <a href="https://hyesugi.com" class="flex items-center justify-center gap-2" aria-label="hyesugi.com으로 이동">
          <img src="https://hyesugi.com/hyesugi.jpg" alt="혜숙이" class="w-14 h-14 rounded-full object-cover border border-red-900">
          당신의 상담친구 혜숙이
        </a>
      </h1>
      <p class="text-sm" style="color:var(--ink-dim)"><b></b>공포 게임</p>
      <button id="menu-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-md hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-red-700/40" aria-label="메뉴 열기">
        <svg class="w-6 h-6" style="color:var(--ink)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
        </svg>
      </button>
    </header>

    <main id="content" class="flex-1 p-4">
      <section class="space-y-4">
        <div id="story-box" class="rounded-2xl p-5 shadow-lg"
             style="background:var(--panel); border:1px solid #161616; line-height:1.85; font-size:1.05rem;">
          <div id="chapter-indicator" class="text-xs uppercase tracking-widest mb-2" style="color:#a40000;">
            준비 중…
          </div>
          <div id="story-text" class="whitespace-pre-wrap"></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="btn-A" class="w-full rounded-xl px-5 py-4 text-lg border transition focus:outline-none focus:ring"
                  style="background:var(--btn-bg); border-color:#2a2a2a; color:var(--ink); font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
            A
          </button>
          <button id="btn-B" class="w-full rounded-xl px-5 py-4 text-lg border transition focus:outline-none focus:ring"
                  style="background:var(--btn-bg); border-color:#2a2a2a; color:var(--ink); font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
            B
          </button>
        </div>
        <p id="slow-count" class="text-center text-sm"
           style="color:var(--ink); font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
          <b>선택 후엔 손가락으로 천천히 다섯을 세시오</b>
        </p>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <button id="btn-restart" class="flex-1 rounded-xl px-5 py-3 text-base border transition"
                  style="background:var(--btn-bg); border-color:#2a2a2a; color:var(--ink-dim); font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
            다른 스토리 진행
          </button>
          <button id="btn-share" class="rounded-xl px-5 py-3 text-base border transition"
                  style="background:var(--btn-bg); border-color:#2a2a2a; color:var(--ink); font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
            공포게임 공유하기
          </button>
        </div>
      </section>
    </main>

    <div id="drawer-overlay" class="fixed inset-0 bg-black/30 hidden z-40"></div>
    <aside id="drawer" class="fixed right-0 top-0 h-full w-1/2 max-w-md bg-white shadow-xl translate-x-full transition-transform duration-300 z-50">
      <div class="flex items-center justify-between p-4 border-b">
        <h2 class="font-bold text-gray-800">메뉴</h2>
        <button id="drawer-close" class="p-2 rounded-md hover:bg-gray-100" aria-label="메뉴 닫기">
          <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav class="p-4 space-y-2">
        <a href="https://hyesugi.com" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">HOME</a>
        <a href="https://hyesugi.com/horror"
           class="block px-3 py-2 rounded-lg hover:bg-gray-100"
           style="color:#e60000; font-family:'Gungsuh','GungSeo','Batang','Gowun Batang',serif;">
          공포 게임
        </a>
      </nav>
    </aside>

    <footer id="site-footer" class="text-center text-sm py-6 space-y-2" style="color:var(--ink-dim)">
      <div>
        <a href="https://hyesugi.com/donation" target="_blank" rel="noopener noreferrer" class="font-semibold hover:underline" style="color:var(--ink);">
          혜숙이에게 커피 한잔 사주기 ☕
        </a>
      </div>
      <hr class="border-t border-gray-700 opacity-50 w-2/3 mx-auto">
      <div id="ad-slot"></div>
    </footer>
  </div>

  <script>
    const menuBtn = document.getElementById('menu-btn');
    const drawer = document.getElementById('drawer');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const drawerClose = document.getElementById('drawer-close');

    function openDrawer() { drawer.classList.remove('translate-x-full'); drawerOverlay.classList.remove('hidden'); }
    function closeDrawer() { drawer.classList.add('translate-x-full'); drawerOverlay.classList.add('hidden'); }

    menuBtn.addEventListener('click', openDrawer);
    drawerOverlay.addEventListener('click', closeDrawer);
    drawerClose.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

  </script>

  <script>
    // 💀 백엔드 API 주소 (Cloudflare Worker 주소 또는 설정한 커스텀 주소)
    const API_ENDPOINT = "/api/horror";

    const storyText = document.getElementById("story-text");
    const chapterIndicator = document.getElementById("chapter-indicator");
    const btnA = document.getElementById("btn-A");
    const btnB = document.getElementById("btn-B");
    const btnRestart = document.getElementById("btn-restart");
    const btnShare = document.getElementById("btn-share");

    function uuid() {
      return crypto.getRandomValues(new Uint8Array(16)).reduce((a,b)=>a+b.toString(16).padStart(2,"0"),"");
    }
    function loadSession() {
      let sessionId = localStorage.getItem("horrorSessionId");
      if (!sessionId) { sessionId = uuid(); localStorage.setItem("horrorSessionId", sessionId); }
      let log = [];
      try { log = JSON.parse(localStorage.getItem("horrorStoryLog") || "[]"); } catch {}
      return { sessionId, log };
    }
    function saveLog(log) { localStorage.setItem("horrorStoryLog", JSON.stringify(log)); }
    function resetAll() { localStorage.removeItem("horrorStoryLog"); localStorage.setItem("horrorSessionId", uuid()); }

    function setChoiceEnabled(ok) {
      [btnA, btnB].forEach(b => {
          b.disabled = !ok;
          b.style.opacity = ok ? "1" : "0.5";
          b.style.cursor = ok ? "pointer" : "not-allowed";
      });
    }

    async function requestChapter({ chapter, choice, reset=false }) {
      const { sessionId, log } = loadSession();
      const payload = { sessionId, chapter, choice, log, reset };
      const r = await fetch(API_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    // === Typewriter: 텍스트박스와 A/B 버튼 라벨에만 적용 ===
    const typeState = { abort:false };
    const delay = (ms)=>new Promise(r=>setTimeout(r, ms));
    async function typeInto(el, text, speed=18, puncExtra=3) {
      typeState.abort = false;
      el.textContent = "";
      for (const ch of text) {
        if (typeState.abort) return;
        el.textContent += ch;
        if ("。,，.!?…！？".includes(ch)) await delay(speed * puncExtra);
        else await delay(speed);
      }
    }

    async function renderChapter(data) {
      const { chapterNumber, text, choices, isFinal } = data;
      chapterIndicator.textContent = `Chapter ${chapterNumber}`;

      setChoiceEnabled(false);
      await typeInto(storyText, text, 18, 3);

      if (choices) {
        btnA.textContent = `A. ${choices.A}`;
        btnB.textContent = `B. ${choices.B}`;
        setChoiceEnabled(true);
      } else {
        btnA.textContent = "A";
        btnB.textContent = "B";
        setChoiceEnabled(false);
      }

      if (isFinal) {
        btnRestart.style.color = 'var(--ink)';
        btnRestart.style.borderColor = 'var(--ink)';
      }

      const state = loadSession();
      const newLog = [...state.log, { chapter: chapterNumber, text }];
      saveLog(newLog);
    }

    async function boot() {
      resetAll();
      setChoiceEnabled(false);
      chapterIndicator.textContent = "이야기 불러오는 중…";
      storyText.textContent = "잠시만 기다리시오… 당신을 위한 공포가 준비되고 있소…";

      try {
        const data = await requestChapter({ chapter: 0, reset: true });
        await renderChapter(data);
      } catch {
        chapterIndicator.textContent = "오류";
        storyText.textContent = "저주받은 페이지... 잠시 후 새로고침하여 다시 시도하시오.";
      }
    }

    async function onPick(choice) {
      try {
        setChoiceEnabled(false);
        typeState.abort = true;

        const state = loadSession();
        const lastChapter = state.log[state.log.length - 1]?.chapter || 0;
        if (state.log.length > 0) {
            state.log[state.log.length - 1].choice = choice;
            saveLog(state.log);
        }

        const next = await requestChapter({ chapter: lastChapter, choice });
        await renderChapter(next);

      } catch {
        alert("알 수 없는 오류가 발생했소. 새로고침하여 다시 시도하시오.");
        setChoiceEnabled(true);
      }
    }

    btnA.addEventListener("click", () => onPick("A"));
    btnB.addEventListener("click", () => onPick("B"));
    btnRestart.addEventListener("click", () => {
        typeState.abort = true;
        resetAll();
        location.reload();
    });
    btnShare.addEventListener('click', async () => {
        const shareData = {
            title: '당신을 공포게임에 초대합니다..',
            text: '선택에 따라 이야기가 바뀌는 인터랙티브 공포 게임',
            url: location.href
        };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(shareData.url);
                alert('게임 주소가 복사되었소. 원하는 곳에 붙여넣으시오.');
            }
        } catch (err) {
            console.error(err);
            alert('공유에 실패했소.');
        }
    });

    [btnA, btnB, btnRestart, btnShare].forEach((el) => {
      el.addEventListener("mouseenter", () => { el.style.background = "var(--btn-bg-hover)"; el.style.boxShadow = "0 0 0 2px var(--ring)"; });
      el.addEventListener("mouseleave", () => { el.style.background = "var(--btn-bg)"; el.style.boxShadow = "none"; });
    });

    boot();
  </script>

</body>
</html>
