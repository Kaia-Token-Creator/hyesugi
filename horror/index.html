<!DOCTYPE html>
<html lang="ko">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QR5TWB3RYJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QR5TWB3RYJ');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9891583086388017"
          crossorigin="anonymous"></script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>당신을 공포게임에 초대합니다</title>
    <meta name="description" content="당신을 공포게임에 초대합니다" />
    <link rel="canonical" href="https://hyesugi.com/horror/" />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#000000" />

    <link rel="icon" href="https://hyesugi.com/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="https://hyesugi.com/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="https://hyesugi.com/site.webmanifest" />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="hyesugi.com" />
    <meta property="og:url" content="https://hyesugi.com/horror/" />
    <meta property="og:title" content="당신을 공포게임에 초대합니다" />
    <meta property="og:description" content="당신을 공포게임에 초대합니다" />
    <meta property="og:image" content="https://hyesugi.com/horror/preview.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="공포 게임 미리보기" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="당신을 공포게임에 초대합니다" />
    <meta name="twitter:description" content="당신을 공포게임에 초대합니다" />
    <meta name="twitter:image" content="https://hyesugi.com/horror/preview.jpg" />
    <link rel="preload" as="image" href="https://hyesugi.com/horror/preview.jpg" />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 궁서체 적용 및 커스텀 스타일 */
        body, h1, h2, p, button, a, footer, main {
            font-family: 'Gungsuh', '궁서', serif;
        }
        .horror-font {
            font-family: 'Gungsuh', '궁서', serif;
            color: #FF0000; /* Red color */
        }
        .horror-bg {
            background-color: #000000; /* Black background */
        }
        /* 로딩 커서 스타일 */
        .typing::after {
            content: '█';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent; }
            50% { color: #FF0000; }
        }
    </style>
</head>
<body class="horror-bg">
    <div id="app" class="flex flex-col min-h-screen max-w-3xl mx-auto horror-bg">
        <header class="horror-bg text-center py-4 shadow-md shadow-red-900/50 relative">
            <h1 class="text-xl font-bold horror-font flex items-center justify-center gap-2">
                <a href="https://hyesugi.com" class="flex items-center justify-center gap-2" aria-label="hyesugi.com으로 이동">
                    <img src="https://hyesugi.com/hyesugi.jpg" alt="혜숙이" class="w-14 h-14 rounded-full object-cover border-2 border-red-700">
                    <span class="horror-font">당신의 상담친구 혜숙이</span>
                </a>
            </h1>
            <p class="text-sm horror-font text-red-700"><b>공포 게임</b></p>
            <button id="menu-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-md hover:bg-red-900/50 focus:outline-none focus:ring-2 focus:ring-red-500" aria-label="메뉴 열기">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
                </svg>
            </button>
        </header>

        <main id="content" class="flex-1 p-4 flex flex-col items-center justify-center space-y-6">
            <div id="story-box" class="w-full min-h-[12rem] p-4 border-2 border-red-700 rounded-lg text-lg leading-relaxed horror-font text-left overflow-y-auto">
                잠깐 기다..려... 손가락으로 천천히 다섯을 세시오
            </div>
            
            <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-a" class="w-full p-4 horror-font bg-gray-900 border border-red-700 rounded-lg hover:bg-red-900/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">선택지 A</button>
                <button id="btn-b" class="w-full p-4 horror-font bg-gray-900 border border-red-700 rounded-lg hover:bg-red-900/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">선택지 B</button>
            </div>
            
            <div class="text-center space-y-4 pt-4">
                    <p class="horror-font text-sm text-red-700">손가락으로 천천히 다섯을 세시오</p>
                    <div class="flex gap-4">
                        <button id="new-story-btn" class="px-4 py-2 horror-font bg-gray-900 border border-red-700 rounded hover:bg-red-900/80 transition-colors">
                            다른 스토리 진행
                        </button>
                        <button id="share-game-btn" class="px-4 py-2 horror-font bg-gray-900 border border-red-700 rounded hover:bg-red-900/80 transition-colors">
                            공포게임 공유하기
                        </button>
                    </div>
            </div>
        </main>
    </div>

    <div id="drawer-overlay" class="fixed inset-0 bg-black/30 hidden z-40"></div>
    <aside id="drawer" class="fixed right-0 top-0 h-full w-1/2 max-w-md bg-white shadow-xl translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="font-bold text-gray-800" style="font-family: sans-serif;">메뉴</h2>
            <button id="drawer-close" class="p-2 rounded-md hover:bg-gray-100" aria-label="메뉴 닫기">
                <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <nav class="p-4 space-y-2" style="font-family: sans-serif;">
            <a href="https://hyesugi.com" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">HOME</a>
            <a href="https://hyesugi.com/luck" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">위로와 행운</a>
            <a href="https://hyesugi.com/fate" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">사주와 궁합</a>
            <a href="https://hyesugi.com/facereading" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">나의 관상은</a>
            <a href="https://hyesugi.com/handreading" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">나의 손금은</a>
            <a href="https://hyesugi.com/board" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">익명 게시판</a>
            <a href="https://hyesugi.com/expert" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">전문가 상담</a>
            <a href="https://hyesugi.com/solo" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">솔로는 여기</a>
            <a href="https://hyesugi.com/money" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">돈되는 정보</a>
            <a href="https://hyesugi.com/game" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">신나는 게임</a>
            <a href="https://hyesugi.com/tube" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">혜숙이 튜브</a>
            <a href="https://hyesugi.com/info" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">이용 안내</a>
            <a href="#" id="share-btn" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-800">공유하기</a>
        </nav>
    </aside>

    <footer id="site-footer" class="text-center text-sm py-6 space-y-2 horror-bg horror-font">
        <div>
            <a href="https://hyesugi.com/donation" target="_blank" rel="noopener noreferrer" class="font-semibold hover:underline horror-font text-red-500">
                혜숙이에게 커피 한잔 사주기 ☕
            </a>
        </div>
        <hr class="border-t border-red-900 opacity-50 w-2/3 mx-auto">
        <div id="ad-slot"></div>
    </footer>
    
    <script>
        // === Drawer Toggle (기존 유지) ===
        const menuBtn = document.getElementById('menu-btn');
        const drawer = document.getElementById('drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerClose = document.getElementById('drawer-close');
        function openDrawer() {
            drawer.classList.remove('translate-x-full');
            drawerOverlay.classList.remove('hidden');
        }
        function closeDrawer() {
            drawer.classList.add('translate-x-full');
            drawerOverlay.classList.add('hidden');
        }
        menuBtn.addEventListener('click', openDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);
        drawerClose.addEventListener('click', closeDrawer);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

        // === Share Button (기존 유지) ===
        const shareBtn = document.getElementById('share-btn');
        if (shareBtn) {
            shareBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const shareData = {
                    title: '혜숙이의 상담소',
                    text: '다정한 AI 상담가 혜숙이와 대화해 보세요.',
                    url: 'https://hyesugi.com'
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(shareData.url);
                        alert('링크가 클립보드에 복사되었습니다: ' + shareData.url);
                    }
                } catch (err) {
                    console.error(err);
                    alert('공유에 실패했어요. 잠시 후 다시 시도해 주세요.');
                }
            });
        }

        // === Footer Ad (기존 유지) ===
        const ads = [
            { text: "인터넷 바꾸면 47만원 지급해드려요!", url: "https://iryan.kr/t73750ushf" },
            { text: "1시간 투자, 월평균 148만원 버는 고효율 부업", url: "https://iryan.kr/t738hkv2k0" },
            { text: "넷플릭스 글로벌 컨텐츠 잠금해제하는 방법", url: "https://hyesugi.com/vpn" },
            { text: "인간으로 살아남기", url: "https://hyesugi.com/world" },
            { text: "노트북, 데스크탑, 아이패드, 태블릿 초특가 구매", url: "https://hyesugi.com/refur" }
        ];
        const pick = ads[Math.floor(Math.random() * ads.length)];
        const slot = document.getElementById("ad-slot");
        if (slot) {
            const a = document.createElement("a");
            a.href = pick.url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "text-red-500 font-bold underline";
            a.textContent = pick.text;
            slot.replaceChildren(a);
        }

        // === 공포 게임 로직 ===
        const storyBox = document.getElementById('story-box');
        const btnA = document.getElementById('btn-a');
        const btnB = document.getElementById('btn-b');
        const newStoryBtn = document.getElementById('new-story-btn');
        const shareGameBtn = document.getElementById('share-game-btn');
        
        let storyHistory = [];
        const loadingMessage = '잠깐 기다..려... 손가락으로 천천히 다섯을 세시오';

        // 1. 타자기 효과 함수 수정 (HTML 태그 처리 가능하도록)
        function typeWriter(element, htmlContent, speed = 50) {
            element.innerHTML = ""; // 기존 내용 비우기
            element.classList.add('typing');

            // 임시 div를 사용하여 HTML 내용을 파싱
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const nodes = Array.from(tempDiv.childNodes); // 노드 리스트를 배열로 변환

            let nodeIndex = 0;
            let charIndex = 0;

            function type() {
                if (nodeIndex < nodes.length) {
                    const currentNode = nodes[nodeIndex];

                    if (currentNode.nodeType === Node.TEXT_NODE) { // 텍스트 노드
                        const text = currentNode.textContent;
                        if (charIndex < text.length) {
                            element.innerHTML += text.charAt(charIndex);
                            charIndex++;
                            setTimeout(type, speed);
                        } else {
                            // 현재 텍스트 노드 완료, 다음 노드로 이동
                            nodeIndex++;
                            charIndex = 0;
                            setTimeout(type, speed);
                        }
                    } else if (currentNode.nodeType === Node.ELEMENT_NODE) { // HTML 요소 노드 (예: <strong>, <br>)
                        element.appendChild(currentNode.cloneNode(true)); // 요소 통째로 추가
                        nodeIndex++;
                        charIndex = 0; // 다음 노드로 이동
                        setTimeout(type, speed);
                    } else { // 기타 노드 (주석 등)
                        nodeIndex++;
                        charIndex = 0;
                        setTimeout(type, speed);
                    }
                } else {
                    element.classList.remove('typing'); // 모든 내용 출력 완료
                }
            }
            type();
        }
        
        // 버튼 상태 관리 함수
        function setButtonsDisabled(disabled) {
            btnA.disabled = disabled;
            btnB.disabled = disabled;
        }

        // 스토리 진행 함수
        async function proceedStory(choice = null) {
            setButtonsDisabled(true);
            storyBox.innerHTML = `<span class="typing">${loadingMessage}</span>`; // 로딩 메시지도 타자기 효과
            
            if (choice) {
                storyHistory.push({ role: 'user', parts: [{ text: `선택: ${choice}` }] });
            }

            try {
                const response = await fetch('/api/horror', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ storyHistory }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // JSON.parse를 한 번 더 거치지 않도록 수정
                const modelResponseData = data; 
                storyHistory.push({ role: 'model', parts: [{ text: JSON.stringify(modelResponseData) }] });


                let fullStoryText = modelResponseData.story;
                if (modelResponseData.chapter === 10 && modelResponseData.finalSentence) {
                    fullStoryText += `<br><br><strong class="text-xl text-red-400">${modelResponseData.finalSentence}</strong>`;
                }

                typeWriter(storyBox, fullStoryText);

                if (modelResponseData.chapter < 10) {
                    btnA.textContent = modelResponseData.choiceA;
                    btnB.textContent = modelResponseData.choiceB;
                    setButtonsDisabled(false);
                } else {
                    btnA.textContent = '...';
                    btnB.textContent = '...';
                    setButtonsDisabled(true);
                }

            } catch (error) {
                console.error("Error fetching story:", error);
                storyBox.innerHTML = `<span class="horror-font text-red-500">이야기를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.</span>`;
            }
        }
        
        // 이벤트 리스너 설정
        btnA.addEventListener('click', () => proceedStory(btnA.textContent));
        btnB.addEventListener('click', () => proceedStory(btnB.textContent));
        
        newStoryBtn.addEventListener('click', () => {
            location.reload();
        });

        shareGameBtn.addEventListener('click', async () => {
            const shareData = {
                title: '혜숙이 공포게임',
                text: '이 저주받은 이야기에 당신을 초대합니다...',
                url: 'https://hyesugi.com/horror/'
            };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(shareData.url);
                    alert('게임 링크가 클립보드에 복사되었습니다.');
                }
            } catch (err) {
                console.error(err);
                alert('공유에 실패했습니다.');
            }
        });

        // 게임 시작
        document.addEventListener('DOMContentLoaded', () => {
            proceedStory();
        });
    </script>
</body>
</html>
